wp.media.view.EnviraVideosError=wp.Backbone.View.extend({tagName:"div",className:"envira-gallery-error envira-videos-error",render:function(){return this.template=wp.media.template("envira-videos-error"),this.$el.html(this.template(this.model)),this}}),wp.media.model.EnviraVideo=Backbone.Model.extend({defaults:{title:"",link:"",image:"",caption:"",alt:"",hosted_video:!1}}),wp.media.view.EnviraVideosItem=wp.Backbone.View.extend({tagName:"li",className:"attachment envira-videos-attachment",events:{"keyup input":"updateItem","change input":"updateItem","keyup textarea":"updateItem","change textarea":"updateItem","click .envira-videos-delete":"deleteItem"},initialize:function(){this.model.view=this},updateItem:function(e){var t=this;this.model.set(e.target.name,e.target.value,{silent:!0}),"link"==e.target.name&&(t.model.set("link",e.target.value,{silent:!0}),""==e.target.value?t.model.set("hosted_video",!1):wp.media.ajax("envira_videos_is_hosted_video",{context:t,data:{nonce:envira_videos_media_view.nonce,video_url:e.target.value},success:function(e){e?(t.model.set("hosted_video",!0),t.model.view.$el.find("div.image").show()):(t.model.set("hosted_video",!1),t.model.view.$el.find("div.image").hide())},error:function(e){t.model.set("hosted_video",!1),void 0!==t.frame&&t.frame.content.get().trigger("loaded loaded:error",e)}})),t.model.get("hosted_video")?t.model.view.$el.find("div.image").show():t.model.view.$el.find("div.image").hide()},deleteItem:function(e){this.trigger("loading"),jQuery(e.target).parent().parent().parent().remove(),this.model.destroy(),this.trigger("loaded loaded:success")},render:function(){return this.template=wp.media.template("envira-videos-item"),this.$el.html(this.template(this.model.toJSON())),this}}),wp.media.view.Toolbar.EnviraVideos=wp.media.view.Toolbar.extend({initialize:function(){_.defaults(this.options,{event:"envira_videos_insert",close:!1,items:{envira_videos_insert:{id:"envira-videos-button",style:"primary",text:wp.media.view.l10n.insertIntoPost,priority:80,requires:!1,click:function(){this.controller.state().enviraVideosInsert()}}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments)},refresh:function(){this.get("envira_videos_insert").model.set("disabled",!1),wp.media.view.Toolbar.prototype.refresh.apply(this,arguments)}}),wp.media.view.EnviraVideos=wp.media.View.extend({events:{"click .envira-videos-add":"addItem","click .envira-insert-video":"insertVideo","click .envira-insert-placeholder":"insertPlaceholder","click .envira-item-collapse":"collapse","keyup input":"refreshView"},initialize:function(){this.collection=new Backbone.Collection,this.is_loading=!1,this.$el.prepend(wp.media.template("envira-videos-router")),this.$el.prepend(wp.media.template("envira-videos-side-bar")),this.$el.prepend(wp.media.template("envira-videos-items")),this.addItem(),this.on("loading",this.loading,this),this.on("loaded",this.loaded,this),0=="ul.attachments.envira-videos-attachments".length&&this.$el.find(".envira-videos-add").click()},collapse:function(e){var t=jQuery(this.$el);$text=t.find(".envira-item-collapse"),e.preventDefault(),t.find(".envira-item-setting").not(".title").is(":visible")?($text.text("Expand"),t.find(".envira-item-setting").not(".title").fadeOut()):($text.text("Collapse"),t.find(".envira-item-setting").not(".title").fadeIn())},loading:function(){this.is_loading=!0,this.$el.find(".spinner").addClass("is-active")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").removeClass("is-active"),this.$el.find("div.envira-gallery-error").remove(),"object"==typeof e&&(e=e.responseText),void 0!==e&&(this.$el.find("div.media-toolbar").after(this.renderError(e)),this.$el.find("ul.attachments.envira-videos-attachments").css("margin-top",this.$el.find("div.envira-gallery-error").height()+20)),this.controller.toolbar.get().refresh()},insertVideo:function(e){var t;$model=this.model,$this=jQuery(this.$el),e.preventDefault();var i=jQuery(e.currentTarget).parent().parent().find("input");t||(t=wp.media.frames.envira_video_frame=wp.media({frame:"select",library:{type:"video"},title:"Select A Video",button:{text:"Submit"},contentUserSetting:!1,multiple:!1})).on("select",(function(){attachment=t.state().get("selection").first().toJSON(),$value=i.val(attachment.url),i.change()})),t.open()},insertPlaceholder:function(e){var t;this.model;e.preventDefault();var i=jQuery(e.currentTarget).parent().parent().find("input");t||(t=wp.media.frames.envira_placeholder_frame=wp.media({frame:"select",library:{type:"image"},title:"Select An Image",button:{text:"Submit"},contentUserSetting:!1,multiple:!1})).on("select",(function(){attachment=t.state().get("selection").first().toJSON(),i.val(attachment.url),i.change()})),t.open()},clearItems:function(){this.$el.find("ul.envira-videos-attachments").empty()},renderError:function(e){var t={};return t.error=e,new wp.media.view.EnviraVideosError({model:t}).render().el},addItem:function(e){this.trigger("loading"),model=new wp.media.model.EnviraVideo,this.getSelection().add(model);var t=new wp.media.view.EnviraVideosItem({model:model,controller:this});this.$el.find("ul.envira-videos-attachments").append(t.render().el),this.trigger("loaded loaded:success")},refreshView:function(e){this.model.each((function(e){e.get("hosted_video")?e.view.$el.find("div.image").fadeIn():e.view.$el.find("div.image").fadeOut()}))},getSelection:function(){return this.controller.state().props},clearSelection:function(){this.selection=this.getSelection(),jQuery("li.attachment.envira-videos-attachment").remove(),this.selection.reset()}});var envira_videos_post_frame=wp.media.view.MediaFrame.Post;wp.media.view.MediaFrame.Post=envira_videos_post_frame.extend({initialize:function(){envira_videos_post_frame.prototype.initialize.apply(this,arguments),this.states.add([new wp.media.controller.EnviraVideos({id:"envira-videos",content:"envira-videos-content",toolbar:"envira-videos-toolbar",menu:"default",title:wp.media.view.l10n.enviraVideosTitle,priority:200,type:"link"})]),this.on("content:render:envira-videos-content",this.renderEnviraVideosContent,this),this.on("toolbar:create:envira-videos-toolbar",this.createEnviraVideosToolbar,this)},renderEnviraVideosContent:function(){this.content.set(new wp.media.view.EnviraVideos({controller:this,model:this.state().props,className:"attachments-browser envira-gallery envira-videos"}))},createEnviraVideosToolbar:function(e){e.view=new wp.media.view.Toolbar.EnviraVideos({controller:this})}}),wp.media.controller.EnviraVideos=wp.media.controller.State.extend({initialize:function(e){this.props=new Backbone.Collection},enviraVideosInsert:function(){var e=[],t=!0,i=this,n=i.frame.content.get();if(i.button=i.frame.toolbar.get().get("envira_videos_insert"),i.button.model.set("text",wp.media.view.l10n.inserting),i.button.model.set("disabled",!0),n.trigger("loading"),n.getSelection().each((function(i){""==i.get("title")&&(t=!1),""==i.get("url")&&(t=!1),i.get("hosted_video")&&""==i.get("image")&&(t=!1),e.push(i.toJSON())}),i),!t)return n.trigger("loaded loaded:error",wp.media.view.l10n.enviraVideosValidationError),i.button.model.set("text",wp.media.view.l10n.insertIntoPost),i.button.model.set("disabled",!1),!1;wp.media.ajax("envira_videos_insert_videos",{context:i,data:{nonce:envira_videos_media_view.nonce,post_id:envira_videos_media_view.post_id,videos:e},success:function(e){jQuery("#envira-gallery-output").html(e),n.trigger("loaded loaded:success"),i.button.model.set("text",wp.media.view.l10n.insertIntoPost),i.button.model.set("disabled",!1),n.clearSelection(),jQuery(document).trigger("enviraInsert"),i.frame.close()},error:function(e){i.button.model.set("text",wp.media.view.l10n.insertIntoPost),i.button.model.set("disabled",!1),n.trigger("loaded loaded:error",e)}})}});